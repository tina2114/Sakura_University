### cpu虚拟化介绍

intel在X86 CPU的基础上增加VMX架构来实现CPU的硬件虚拟化，VMX架构下有两类角色：虚拟机监视器（VMM）和虚拟机（VM）。VMM对整个系统的CPU和硬件有完全的控制权，它抽象出虚拟的CPU给各个VM，并能够将VM的CPU直接调度到物理CPU上运行。VM是一个虚拟机实例，能够支持操作系统以及各种软件栈和应用程序。

在QEMU中，QEMU/KVM是作为VMM，你挂载的虚拟机镜像作为VM。QEMU负责模拟整个电脑，构建对应架构，但是其中内存和CPU的虚拟化工作由KVM进行负责。

#### VMCS介绍

VMCS用来管理VMX non-root Operation的转换以及控制VCPU的行为。VMCS之于VCPU的作用类似于进程描述符之于进程的作用。

在VMCS的格式中，前8个字节是固定的，第一个4字节的第0位到第30位表示修正标识符，用来识别不同的VMCS版本，第一个4字节的第31位是shadow-VMCS indicator，VMM根据这个来判断是一个普通的VMCS还是shadow VMCS[^shadow]。VMCS的第二个4字节是VMX-abort indicator，当VM Exit发生错误时，会产生VMX-abort，导致处理器进入关闭，处理器写入一个非零值到VMX-abort indicator

[^shadow]: VMCS SHADOW允许硬件加速vmread，vmwrite指令，它允许VMM不拦截VMCS读/写的某些字段

VMCS数据区控制着VMX non-root和VMX root之间的转换，VMM通过VMREAD和VMWRITE指令在这里读写。一共6个数据区：

1. Guest-state区域，进行VM Entry时，虚拟机处理器的状态信息从这个区域加载，进行VM Exit的时候，虚拟机的当前状态信息写入到这个区域
2. Host-state区域，发生VM Exit的时候，需要切换到VMM的上下文运行，此时处理器的状态信息从这里加载
3. VM-execution控制区域，用来控制处理器在进入VM Entry之后的处理器行为
4. VM Exit控制区域，用来指定虚拟机在发生VM Exit时的行为，如一些寄存器的保存
5. VM Entry控制区域，指定虚拟机在发生VM Entry时的行为，如一些寄存器的加载
6. VM Exit信息区域，包含了最近产生的VM Exit信息，典型的信息包括退出的原因以及相应的数据

VCPU之间会共享物理CPU，VMM负责在多个VCPU之间分配物理CPU，每个VCPU都有自己的描述符，当VMM在切换VCPU运行时需要保存此时VCPU的状态。

### KVM模块初始化

KVM是基于内核的虚拟机监视器

KVM模块的初始化主要包括初始化CPU与架构无关的数据以及设置与架构有关的虚拟化支持